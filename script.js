// Default templates configuration for both categories
const defaultTemplates = {
  Black: {
    1: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 60.5,
          yPercent: 43,
          right: 36,
          rotation: -76,
          fontSize: 32,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 28.5,
          yPercent: 54.5,
          rotation: 25,
          fontSize: 16,
        },
      ],
    },
    2: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 60,
          yPercent: 43,
          right: 38,
          rotation: -76,
          fontSize: 30,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 29,
          yPercent: 54.5,
          rotation: 24,
          fontSize: 15,
        },
        {
          id: "text3",
          content: "DANIELSSSON",
          xPercent: 39,
          right: 25.5,
          yPercent: 58.5,
          rotation: -60,
          fontSize: 15,
        },
      ],
    },
    3: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 60,
          yPercent: 43,
          right: 37.5,
          rotation: -76,
          fontSize: 32,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 29,
          yPercent: 54,
          rotation: 25,
          fontSize: 15,
        },
        {
          id: "text3",
          content: "DANIELSSSON",
          xPercent: 40,
          right: 26.5,
          yPercent: 59.5,
          rotation: -56,
          fontSize: 15,
        },
        {
          id: "text4",
          content: "DANIELSSSON",
          xPercent: 65.5,
          right: 42.5,
          yPercent: 55,
          rotation: -24,
          fontSize: 15,
        },
      ],
    },
    4: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 60,
          yPercent: 43,
          right: 37.5,
          rotation: -76,
          fontSize: 32,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 29,
          yPercent: 55,
          rotation: 23,
          fontSize: 15,
        },
        {
          id: "text3",
          content: "DANIELSSSON",
          xPercent: 39,
          right: 26.5,
          yPercent: 59,
          rotation: -59,
          fontSize: 15,
        },
        {
          id: "text4",
          content: "DANIELSSSON",
          xPercent: 65,
          right: 39,
          yPercent: 55,
          rotation: -21,
          fontSize: 14,
        },
        {
          id: "text5",
          content: "DANIELSSSON",
          xPercent: 36.5,
          yPercent: 46.5,
          rotation: 18,
          fontSize: 15,
        },
      ],
    },
    5: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 60.5,
          yPercent: 41.5,
          right: 37.5,
          rotation: -76,
          fontSize: 32,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 29.5,
          yPercent: 55,
          rotation: 24,
          fontSize: 15,
        },
        {
          id: "text3",
          content: "DANIELSSSON",
          xPercent: 40,
          right: 27.5,
          yPercent: 60,
          rotation: -58,
          fontSize: 15,
        },
        {
          id: "text4",
          content: "DANIELSSSON",
          xPercent: 65.5,
          right: 37,
          yPercent: 55,
          rotation: -24,
          fontSize: 15,
        },
        {
          id: "text5",
          content: "DANIELSSSON",
          xPercent: 37.5,
          yPercent: 46.5,
          rotation: 16,
          fontSize: 15,
        },
        {
          id: "text6",
          content: "DANIELSSSON",
          xPercent: 65,
          right: 34,
          yPercent: 66.5,
          rotation: 72,
          fontSize: 15,
        },
      ],
    },
    6: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 60.5,
          yPercent: 41.5,
          right: 37.5,
          rotation: -76,
          fontSize: 32,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 29,
          yPercent: 54.5,
          rotation: 24,
          fontSize: 15,
        },
        {
          id: "text3",
          content: "DANIELSSSON",
          xPercent: 41,
          right: 29,
          yPercent: 61,
          rotation: -56,
          fontSize: 15,
        },
        {
          id: "text4",
          content: "DANIELSSSON",
          xPercent: 65.5,
          right: 37,
          yPercent: 55,
          rotation: -24,
          fontSize: 15,
        },
        {
          id: "text5",
          content: "DANIELSSSON",
          xPercent: 37.5,
          yPercent: 46.5,
          rotation: 16,
          fontSize: 15,
        },
        {
          id: "text6",
          content: "DANIELSSSON",
          xPercent: 65,
          right: 34,
          yPercent: 67,
          rotation: 72,
          fontSize: 15,
        },
        {
          id: "text7",
          content: "DANIELSSSON",
          xPercent: 67,
          right: 29,
          yPercent: 40,
          rotation: -33,
          fontSize: 15,
        },
      ],
    },
  },
  Colored: {
    1: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 60,
          yPercent: 44.5,
          right: 36.5,
          rotation: -76,
          fontSize: 32,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 29,
          yPercent: 55,
          rotation: 22,
          fontSize: 18,
        },
      ],
    },
    2: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 60,
          yPercent: 44.5,
          right: 36.5,
          rotation: -76,
          fontSize: 32,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 29,
          yPercent: 55,
          rotation: 22,
          fontSize: 18,
        },
        {
          id: "text3",
          content: "DANIELSSSON",
          xPercent: 40,
          right: 27,
          yPercent: 60,
          rotation: -56,
          fontSize: 18,
        },
      ],
    },
    3: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 60,
          yPercent: 44.5,
          right: 36.5,
          rotation: -76,
          fontSize: 32,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 29,
          yPercent: 55,
          rotation: 22,
          fontSize: 18,
        },
        {
          id: "text3",
          content: "DANIELSSSON",
          xPercent: 40,
          right: 27,
          yPercent: 60,
          rotation: -56,
          fontSize: 18,
        },
        {
          id: "text4",
          content: "DANIELSSSON",
          xPercent: 65,
          right: 37,
          yPercent: 55,
          rotation: -18,
          fontSize: 15,
        },
      ],
    },
    4: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 60,
          yPercent: 44.5,
          right: 36.5,
          rotation: -76,
          fontSize: 32,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 29,
          yPercent: 55,
          rotation: 22,
          fontSize: 18,
        },
        {
          id: "text3",
          content: "DANIELSSSON",
          xPercent: 40,
          right: 27,
          yPercent: 60,
          rotation: -56,
          fontSize: 18,
        },
        {
          id: "text4",
          content: "DANIELSSSON",
          xPercent: 65,
          right: 37,
          yPercent: 55,
          rotation: -18,
          fontSize: 15,
        },
        {
          id: "text5",
          content: "DANIELSSSON",
          xPercent: 35.5,
          yPercent: 46.5,
          rotation: 15,
          fontSize: 18,
        },
      ],
    },
    5: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 60,
          yPercent: 44.5,
          right: 36.5,
          rotation: -76,
          fontSize: 32,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 29,
          yPercent: 55,
          rotation: 22,
          fontSize: 18,
        },
        {
          id: "text3",
          content: "DANIELSSSON",
          xPercent: 40,
          right: 27,
          yPercent: 60,
          rotation: -56,
          fontSize: 18,
        },
        {
          id: "text4",
          content: "DANIELSSSON",
          xPercent: 65,
          right: 37,
          yPercent: 55,
          rotation: -18,
          fontSize: 15,
        },
        {
          id: "text5",
          content: "DANIELSSSON",
          xPercent: 35.5,
          yPercent: 46.5,
          rotation: 15,
          fontSize: 18,
        },
        {
          id: "text6",
          content: "DANIELSSSON",
          xPercent: 65,
          right: 34,
          yPercent: 67,
          rotation: 72,
          fontSize: 15,
        },
      ],
    },
    6: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 57.5,
          yPercent: 40.5,
          right: 34.5,
          rotation: -76,
          fontSize: 32,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 24,
          yPercent: 55.5,
          rotation: 22,
          fontSize: 15,
        },
        {
          id: "text3",
          content: "DANIELSSSON",
          xPercent: 33,
          right: 27.5,
          yPercent: 57,
          rotation: -57,
          fontSize: 15,
        },
        {
          id: "text4",
          content: "DANIELSSSON",
          xPercent: 58.5,
          right: 36,
          yPercent: 54,
          rotation: -26,
          fontSize: 15,
        },
        {
          id: "text5",
          content: "DANIELSSSON",
          xPercent: 31.5,
          yPercent: 47,
          rotation: 17,
          fontSize: 15,
        },
        {
          id: "text6",
          content: "DANIELSSSON",
          xPercent: 56,
          right: 37.5,
          yPercent: 69.5,
          rotation: 74,
          fontSize: 15,
        },
        {
          id: "text7",
          content: "DANIELSSSON",
          xPercent: 59.5,
          right: 28.5,
          yPercent: 38,
          rotation: -35,
          fontSize: 14,
        },
      ],
    },
  },
  White: {
    1: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 57,
          yPercent: 41.5,
          right: 38.5,
          rotation: -76,
          fontSize: 32,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 25.5,
          yPercent: 55.5,
          rotation: 22,
          fontSize: 15,
        },
      ],
    },
    2: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 57.5,
          yPercent: 41.5,
          right: 38,
          rotation: -76,
          fontSize: 32,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 26,
          yPercent: 55.5,
          rotation: 23,
          fontSize: 15,
        },
        {
          id: "text3",
          content: "DANIELSSSON",
          xPercent: 35.5,
          right: 26.5,
          yPercent: 57.5,
          rotation: -58,
          fontSize: 15,
        },
      ],
    },
    3: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 57.5,
          yPercent: 41.5,
          right: 38.5,
          rotation: -76,
          fontSize: 32,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 26,
          yPercent: 55.5,
          rotation: 20,
          fontSize: 15,
        },
        {
          id: "text3",
          content: "DANIELSSSON",
          xPercent: 33.5,
          right: 24.5,
          yPercent: 55.5,
          rotation: -60,
          fontSize: 15,
        },
        {
          id: "text4",
          content: "DANIELSSSON",
          xPercent: 60.5,
          right: 36,
          yPercent: 54.5,
          rotation: -22,
          fontSize: 15,
        },
      ],
    },
    4: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 62,
          yPercent: 38,
          right: 26,
          rotation: -78,
          fontSize: 32,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 26.5,
          yPercent: 56,
          rotation: 22,
          fontSize: 14,
        },
        {
          id: "text3",
          content: "DANIELSSSON",
          xPercent: 35.5,
          right: 27,
          yPercent: 58,
          rotation: -56,
          fontSize: 15,
        },
        {
          id: "text4",
          content: "DANIELSSSON",
          xPercent: 60.5,
          right: 36.5,
          yPercent: 55,
          rotation: -26,
          fontSize: 15,
        },
        {
          id: "text5",
          content: "DANIELSSSON",
          xPercent: 34,
          yPercent: 47.5,
          rotation: 17,
          fontSize: 15,
        },
      ],
    },
    5: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 57.5,
          yPercent: 41,
          right: 38,
          rotation: -76,
          fontSize: 32,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 26.5,
          yPercent: 56,
          rotation: 22,
          fontSize: 15,
        },
        {
          id: "text3",
          content: "DANIELSSSON",
          xPercent: 34.5,
          right: 24.5,
          yPercent: 57,
          rotation: -57,
          fontSize: 15,
        },
        {
          id: "text4",
          content: "DANIELSSSON",
          xPercent: 60.5,
          right: 34,
          yPercent: 54.5,
          rotation: -27,
          fontSize: 15,
        },
        {
          id: "text5",
          content: "DANIELSSSON",
          xPercent: 34,
          yPercent: 47.5,
          rotation: 15,
          fontSize: 14,
        },
        {
          id: "text6",
          content: "DANIELSSSON",
          xPercent: 60.5,
          right: 42,
          yPercent: 67,
          rotation: 73,
          fontSize: 14,
        },
      ],
    },
    6: {
      textFields: [
        {
          id: "text1",
          content: "MORFAR",
          xPercent: 58,
          yPercent: 41,
          right: 36.5,
          rotation: -76,
          fontSize: 32,
        },
        {
          id: "text2",
          content: "DANIELSSSON",
          xPercent: 26,
          yPercent: 56,
          rotation: 23,
          fontSize: 15,
        },
        {
          id: "text3",
          content: "DANIELSSSON",
          xPercent: 35.5,
          right: 28,
          yPercent: 58.5,
          rotation: -58,
          fontSize: 15,
        },
        {
          id: "text4",
          content: "DANIELSSSON",
          xPercent: 61,
          right: 37.5,
          yPercent: 55,
          rotation: -28,
          fontSize: 14,
        },
        {
          id: "text5",
          content: "DANIELSSSON",
          xPercent: 34.5,
          yPercent: 47.5,
          rotation: 15,
          fontSize: 14,
        },
        {
          id: "text6",
          content: "DANIELSSSON",
          xPercent: 56.5,
          right: 33,
          yPercent: 71,
          rotation: 73,
          fontSize: 14,
        },
        {
          id: "text7",
          content: "DANIELSSSON",
          xPercent: 62,
          right: 28,
          yPercent: 38.5,
          rotation: -35,
          fontSize: 14,
        },
      ],
    },
  },
};

// Current state
let originalFieldValues = {};
let currentKids = 1;
let currentColor = "Black";
let currentTemplates = JSON.parse(JSON.stringify(defaultTemplates["Black"]));
let textOverlays = {};
let selectedOverlay = null;
let isDragging = false;
let dragStartPos = { x: 0, y: 0 };

const deltaX = 50;
const MAX_PERSONALIZATION_CHARS = 10; // Maximum character limit for personalization

// DOM elements
const baseImage = document.getElementById("baseImage");
const skeleton = document.getElementById("imageSkeleton");
const imageContainer = document.getElementById("imageContainer");
const textControlsContainer = document.getElementById("text-controls");
const exportBtn = document.getElementById("exportBtn");

// Initialize the application
function init() {
  setupEventListeners();
  updateImageSource();
}

function setupEventListeners() {
  // Kids selection
  document.querySelectorAll('input[name="kids"]').forEach((radio) => {
    radio.addEventListener("change", handleKidsChange);
  });

  // Color variants
  document.querySelectorAll(".color-variant").forEach((variant) => {
    variant.addEventListener("click", handleColorChange);
  });

  // Export
  exportBtn.addEventListener("click", exportTemplate);

  // Image container mouse events for dragging
  imageContainer.addEventListener("mousedown", handleMouseDown);
  document.addEventListener("mousemove", handleMouseMove);
  document.addEventListener("mouseup", handleMouseUp);
}

function storeOriginalValues() {
  const template = currentTemplates[currentKids];
  originalFieldValues[currentKids] = {};

  template.textFields.forEach((field) => {
    originalFieldValues[currentKids][field.id] = {
      xPercent: field.xPercent,
      yPercent: field.yPercent,
      right: field.right || undefined,
      rotation: field.rotation,
      fontSize: field.fontSize,
    };
  });
}

function handleKidsChange(e) {
  // Update selected style
  document.querySelectorAll(".kids-options .option-item").forEach((item) => {
    item.classList.remove("selected");
  });
  e.target.parentElement.classList.add("selected");

  currentKids = parseInt(e.target.value);
  updateImageSource();
}

function handleColorChange(e) {
  // Update selected style
  document.querySelectorAll(".color-variant").forEach((variant) => {
    variant.classList.remove("selected");
  });
  e.target.classList.add("selected");

  currentColor = e.target.dataset.color;
  const templateKey =
    currentColor === "White"
      ? "White"
      : currentColor === "Black"
      ? "Black"
      : "Colored";
  currentTemplates = JSON.parse(JSON.stringify(defaultTemplates[templateKey]));

  updateImageSource();
}

function updateImageSource() {
  clearOverlays();

  baseImage.style.display = "none";

  // Show loader and hide image
  skeleton.style.display = "block";

  // Construct new image URL (now inside assets folder)
  let imageUrl;
  imageUrl = `assets/Mug/${currentColor}/${currentKids} Kid${
    currentKids > 1 ? "s" : ""
  } ${currentColor} Mug.jpeg`;

  // Set image source
  baseImage.src = imageUrl;

  // Wait for it to fully load
  baseImage.onload = function () {
    // Hide loader and show image
    skeleton.style.display = "none";
    baseImage.style.display = "block";

    updateTemplate();
  };
}

function updateTemplate() {
  clearOverlays();
  createTextControls();
  createTextOverlays();
  storeOriginalValues();
}

function clearOverlays() {
  document.querySelectorAll(".text-overlay").forEach((overlay) => {
    overlay.remove();
  });
  textOverlays = {};
  selectedOverlay = null;
}

function createTextControls() {
  textControlsContainer.innerHTML = "";

  const template = currentTemplates[currentKids];

  template.textFields.forEach((field, index) => {
    const controlGroup = document.createElement("div");
    controlGroup.className = "text-input-group";
    controlGroup.dataset.fieldId = field.id;

    const xControl = `
        <div class="control-row">
          <span class="control-label">X: ${field.xPercent}%</span>
          <div class="control-buttons">
            <button class="control-btn" onclick="adjustField('${field.id}', 'xPercent', -0.5)">-</button>
            <button class="control-btn" onclick="adjustField('${field.id}', 'xPercent', 0.5)">+</button>
          </div>
        </div>
      `;

    controlGroup.innerHTML = `
      <div class="form-group">
        <label>${field.id === "text1" ? "Dad/Mom" : `Child ${index}`}</label>
        <input type="text" value="${
          field.content || ""
        }" onchange="updateFieldContent('${field.id}', this.value)">
      </div>
      <div class="control-group">
        ${xControl}
        <div class="control-row">
          <span class="control-label">Y: ${field.yPercent}%</span>
          <div class="control-buttons">
            <button class="control-btn" onclick="adjustField('${
              field.id
            }', 'yPercent', -0.5)">-</button>
            <button class="control-btn" onclick="adjustField('${
              field.id
            }', 'yPercent', 0.5)">+</button>
          </div>
        </div>
        ${
          field.right
            ? `<div class="control-row">
              <span class="control-label">Right: ${field.right}%</span>
              <div class="control-buttons">
                <button
                  class="control-btn"
                  onclick="adjustField('${field.id}', 'right', -0.5)"
                >
                  -
                </button>
                <button
                  class="control-btn"
                  onclick="adjustField('${field.id}', 'right', 0.5)"
                >
                  +
                </button>
              </div>
            </div>`
            : ""
        }
        <div class="control-row">
          <span class="control-label">Rotation: ${field.rotation}°</span>
          <div class="control-buttons">
            <button class="control-btn" onclick="adjustField('${
              field.id
            }', 'rotation', -1)">-</button>
            <button class="control-btn" onclick="adjustField('${
              field.id
            }', 'rotation', 1)">+</button>
          </div>
        </div>
        <div class="control-row">
          <span class="control-label">Size: ${field.fontSize}px</span>
          <div class="control-buttons">
            <button class="control-btn" onclick="adjustField('${
              field.id
            }', 'fontSize', -1)">-</button>
            <button class="control-btn" onclick="adjustField('${
              field.id
            }', 'fontSize', 1)">+</button>
          </div>
        </div>
      </div>
    `;

    textControlsContainer.appendChild(controlGroup);
  });
}

function createTextOverlays() {
  const template = currentTemplates[currentKids];
  const imageWrapper = document.querySelector(".image-wrapper");

  template.textFields.forEach((field) => {
    // Single overlay for categories (no printFile)
    const overlay = createOverlay(field);
    imageWrapper.appendChild(overlay);
    textOverlays[field.id] = overlay;
  });
}

function createOverlay(field) {
  const overlay = document.createElement("div");
  overlay.className = "text-overlay";
  overlay.dataset.fieldId = `overlay-${field.id}`;
  overlay.textContent = field.content || "";

  // Set position and rotation - note that transform-origin should be "left center" in CSS
  overlay.style.left = `${field.xPercent}%`;
  overlay.style.top = `${field.yPercent}%`;
  if (field.right) {
    overlay.style.right = `${field.right}%`;
  }
  overlay.style.transform =
    field.id === "text1"
      ? `translate(-100%, -50%) rotate(${field.rotation}deg)`
      : `translate(0, -50%) rotate(${field.rotation}deg)`;
  overlay.style.fontSize = `${field.fontSize}px`;

  // Ensure consistent vertical alignment
  overlay.style.lineHeight = "1";
  overlay.style.display = "inline-block";
  overlay.style.verticalAlign = "middle";

  // Apply dynamic font sizing based on text length
  adjustFontSize(overlay, field.fontSize);

  overlay.addEventListener("click", () => selectOverlay(overlay));

  return overlay;
}

// Font adjustment function similar to backend logic
function adjustFontSize(overlay, baseFontSize) {
  const charCount = overlay.textContent.trim().length;
  const maxChars = MAX_PERSONALIZATION_CHARS; // 10 characters

  // Check if device is mobile
  const isMobile = window.innerWidth <= 768;

  // Different scaling factors for mobile and desktop
  const minScaleFactor = isMobile ? 0.4 : 0.6;

  // Linearly scale down from 100% to minScaleFactor as char count goes from 1 to maxChars
  const scaleFactor =
    1 - ((charCount - 1) / (maxChars - 1)) * (1 - minScaleFactor);
  const adjustedFontSize = baseFontSize * scaleFactor;

  // Ensure the font size doesn't go below the minimum scale
  overlay.style.fontSize = `${Math.max(
    adjustedFontSize,
    baseFontSize * minScaleFactor
  )}px`;
}

function selectOverlay(overlay) {
  // Remove previous selection
  document.querySelectorAll(".text-overlay").forEach((o) => {
    o.classList.remove("selected");
  });
  document.querySelectorAll(".text-input-group").forEach((g) => {
    g.classList.remove("active");
  });

  // Select new overlay only if overlay is not null
  if (overlay) {
    const fieldId = overlay.dataset.fieldId.split("-")[1]; // Get base fieldId (e.g., text1)
    overlay.classList.add("selected");
    selectedOverlay = overlay;

    // Highlight corresponding control group
    const controlGroup = document.querySelector(
      `[data-field-id="overlay-${fieldId}"]`
    );
    if (controlGroup) {
      controlGroup.classList.add("active");
    }
  } else {
    selectedOverlay = null;
  }
}

function updateFieldContent(fieldId, newContent) {
  const template = currentTemplates[currentKids];
  const field = template.textFields.find((f) => f.id === fieldId);
  if (field) {
    field.content = newContent;
    const overlay = textOverlays[fieldId];
    if (overlay) {
      overlay.textContent = newContent;
      // Reapply font size adjustment when content changes
      adjustFontSize(overlay, field.fontSize);
    }
  }
}

function adjustField(fieldId, property, delta) {
  const template = currentTemplates[currentKids];
  const field = template.textFields.find((f) => f.id === fieldId);

  if (!field) return;

  // Get original values
  const originalValues = originalFieldValues[currentKids]?.[fieldId];
  if (!originalValues) return;

  // Apply adjustment
  let newValue = field[property] + delta;

  // Set bounds based on property with limits from original values
  switch (property) {
    case "xPercent":
      const originalPos = originalValues.xPercent;
      const minPos = Math.max(0, originalPos - 15);
      const maxPos = Math.min(100, originalPos + 15);
      newValue = Math.max(minPos, Math.min(maxPos, newValue));
      break;
    case "yPercent":
      const originalY = originalValues.yPercent;
      const minY = Math.max(0, originalY - 15);
      const maxY = Math.min(100, originalY + 15);
      newValue = Math.max(minY, Math.min(maxY, newValue));
      break;
    case "right":
      const originalRight = originalValues.right;
      const minRight = Math.max(0, originalRight - 25);
      const maxRight = Math.min(100, originalRight + 25);
      newValue = Math.max(minRight, Math.min(maxRight, newValue));
      break;
    case "rotation":
      const originalRot = originalValues.rotation;
      const minRot = originalRot - 50;
      const maxRot = originalRot + 50;
      newValue = Math.max(minRot, Math.min(maxRot, newValue));
      break;
    case "fontSize":
      const originalSize = originalValues.fontSize;
      const minSize = Math.max(8, originalSize - 5);
      const maxSize = Math.min(72, originalSize + 5);
      newValue = Math.max(minSize, Math.min(maxSize, newValue));
      break;
  }

  field[property] = newValue;

  // Update overlay
  updateOverlayStyle(fieldId);

  // Update control labels
  updateControlLabels(fieldId);
}

function updateOverlayStyle(fieldId) {
  const template = currentTemplates[currentKids];
  const field = template.textFields.find((f) => f.id === fieldId);

  if (!field) return;

  const overlay = textOverlays[fieldId];
  if (overlay) {
    overlay.style.left = `${field.xPercent}%`;
    overlay.style.top = `${field.yPercent}%`;
    overlay.style.right = `${field.right}%`;
    overlay.style.transform =
      field.id === "text1"
        ? `translate(-100%, -50%) rotate(${field.rotation}deg)`
        : `translate(0, -50%) rotate(${field.rotation}deg)`;

    // Update font size and apply dynamic sizing
    overlay.style.fontSize = `${field.fontSize}px`;
    adjustFontSize(overlay, field.fontSize);
  }
}

function updateControlLabels(fieldId) {
  const template = currentTemplates[currentKids];
  template.textFields.forEach((field) => {
    if (field.id !== fieldId) return;

    const controlGroup = document.querySelector(
      `.text-input-group[data-field-id="${field.id}"]`
    );
    if (!controlGroup) return;

    const labels = controlGroup.querySelectorAll(".control-label");

    if (labels.length >= 5) {
      labels[0].textContent = `X: ${field.xPercent}%`;
      labels[1].textContent = `Y: ${field.yPercent}%`;
      labels[2].textContent = `Right: ${field.right}%`;
      labels[3].textContent = `Rotation: ${field.rotation}°`;
      labels[4].textContent = `Size: ${field.fontSize}px`;
    } else {
      labels[0].textContent = `X: ${field.xPercent}%`;
      labels[1].textContent = `Y: ${field.yPercent}%`;
      labels[2].textContent = `Rotation: ${field.rotation}°`;
      labels[3].textContent = `Size: ${field.fontSize}px`;
    }
  });
}

// Mouse event handlers for dragging
function handleMouseDown(e) {
  const overlay = e.target.closest(".text-overlay");
  if (!overlay) return;

  e.preventDefault();
  isDragging = true;
  selectedOverlay = overlay;

  overlay.classList.add("dragging");
  selectOverlay(overlay);

  const rect = imageContainer.getBoundingClientRect();
  dragStartPos = {
    x: e.clientX - rect.left,
    y: e.clientY - rect.top,
  };
}

function handleMouseMove(e) {
  if (!isDragging || !selectedOverlay) return;

  e.preventDefault();

  const rect = imageContainer.getBoundingClientRect();
  const imageRect = baseImage.getBoundingClientRect();

  // Calculate position relative to the image
  const x = e.clientX - imageRect.left;
  const y = e.clientY - imageRect.top;

  let xPercent = Math.max(0, Math.min(100, (x / imageRect.width) * 100));
  let yPercent = Math.max(0, Math.min(100, (y / imageRect.height) * 100));

  // Get field ID and original values
  const fieldId = selectedOverlay.dataset.fieldId.split("-")[1];
  const originalValues = originalFieldValues[currentKids]?.[fieldId];
  const template = currentTemplates[currentKids];
  const field = template.textFields.find((f) => f.id === fieldId);

  if (originalValues) {
    // Apply position bounds (+/-15% from original)
    const minX = Math.max(0, originalValues.xPercent - 15);
    const maxX = Math.min(100, originalValues.xPercent + 15);
    const minY = Math.max(0, originalValues.yPercent - 15);
    const maxY = Math.min(100, originalValues.yPercent + 15);

    xPercent = Math.max(minX, Math.min(maxX, xPercent));
    yPercent = Math.max(minY, Math.min(maxY, yPercent));
  }

  // Update overlay position with left alignment
  selectedOverlay.style.left = `${xPercent}%`;
  selectedOverlay.style.top = `${yPercent}%`;

  // Update template data
  if (field) {
    field.xPercent = Math.round(xPercent);
    field.yPercent = Math.round(yPercent);
  }
}

function handleMouseUp(e) {
  if (isDragging && selectedOverlay) {
    selectedOverlay.classList.remove("dragging");
    const fieldId = selectedOverlay.dataset.fieldId.split("-")[1];
    updateControlLabels(fieldId);
  }

  isDragging = false;
  selectedOverlay = null;
  selectOverlay(null);
}

function exportTemplate() {
  const exportData = {
    templates: currentTemplates,
    color: currentColor,
    imageSize: {
      width: baseImage.naturalWidth,
      height: baseImage.naturalHeight,
    },
    metadata: {
      exportDate: new Date().toISOString(),
      version: "1.0",
      publisher: "10daer",
    },
  };

  const dataStr = JSON.stringify(exportData, null, 2);
  const dataBlob = new Blob([dataStr], { type: "application/json" });

  // Save to assets/template folder
  const fileName = `Mug-${currentColor}-template-config-${Date.now()}.json`;
  const filePath = `assets/template/${fileName}`;

  // For browsers, we can't write directly to disk, so we just set the download path as a suggestion
  const link = document.createElement("a");
  link.href = URL.createObjectURL(dataBlob);
  link.download = filePath;
  link.click();

  URL.revokeObjectURL(link.href);
}

// Make functions globally available
window.updateFieldContent = updateFieldContent;
window.adjustField = adjustField;

// Initialize the application when DOM is loaded
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", init);
} else {
  init();
}
